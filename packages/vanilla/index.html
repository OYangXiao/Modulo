<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <script type="systemjs-importmap">
{
  "imports": {
     "react": "https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js",
  "react-dom": "/packages/common/js/react-17.0.2/umd/react-dom.production.min.js",
  "react/jsx-runtime": "/packages/common/js/react-17.0.2/umd/react-jsx-runtime.js",
  "jquery": "https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js",
  "rxjs": "https://cdn.jsdelivr.net/npm/rxjs@7.8.2/dist/bundles/rxjs.umd.min.js",
  "vue": "/packages/vue-2.7.16/node_modules/vue/dist/vue.js"
  }
}
</script>
  <!-- <script src="/packages/vue-2.7.16/node_modules/vue/dist/vue.js"></script> -->
  <script src="/packages/webhost/dist/webhost.system.js"></script>
<body>
  <div id="react-app"></div>
  <div id="vue-bare-app"></div>
  <div id="vue-extended-app"></div>
  <script>
    async function init(){
      // webhost 函数现在通过 window.webhost.remote_module 全局暴露

      // 加载并挂载 React 组件
      window.webhost.remote_module.mount_react({
        path:'/packages/react-17.0.2/dist/modules/umd/react-counter.js', 
        root:'#react-app', 
        key:'Counter'
      });

      // 加载并挂载 Vue 裸模块组件
      window.webhost.remote_module.mount_vue2({
        path:'/packages/vue-2.7.16/dist/modules/umd/vue-module.js', 
        root:'#vue-bare-app'
      });
    }
    init()
  </script>
  <script>
    class WebhostIsolatedElement extends HTMLElement {

      static get observedAttributes() {
        return ['html', 'params']; // 必须返回要监听的属性数组
      }

      constructor() {
        super();
      }

      connectedCallback() {
        this.attachShadow({ mode: 'open' });
        console.log('connectedCallback')
        const attr_html =  this.getAttribute('html')
        const attr_params = this.getAttribute('params')

        this.setHtml(attr_html)
        this.updateData(attr_params)
      }


      attributeChangedCallback(name, oldValue, newValue) {
        console.log(name, oldValue, newValue)
        if(name === 'params'){
          this.updateData(newValue)
        }
        if(name === 'html'){
          this.setHtml(newValue)
        }
      }


      setHtml(url){
        if(!this.shadowRoot){
          console.log('shadowRoot is null')
          return 
        }
        this.shadowRoot.innerHTML = ''
        fetch(url)
          .then(response => response.text())
          .then(html => {
            const template = document.createElement('template')
            template.innerHTML = html
            const scripts = template.content.querySelectorAll('script')
            const component_script = scripts[scripts.length - 1]
            const script_content = component_script.innerText
            component_script.remove()

            this.shadowRoot.appendChild(template.content)

            const script = eval(script_content)
            this._update = script(this.shadowRoot)
          })
      }

      updateData(params){
        if(this._update){
          this._update(params)
        }
      }
    }
    customElements.define('webhost-isolated-element', WebhostIsolatedElement)
  </script>
  
  <webhost-isolated-element id="html-component" html="./banner.html"></webhost-isolated-element>
  <!-- <script>
    setTimeout(() => {
      
    const html_component = document.getElementById('html-component')
    html_component.setAttribute('html', '/packages/vanilla/html-component/index.html')
    html_component.setAttribute('params', JSON.stringify({stockName:'腾讯'}))
    }, 1000);
  </script> -->
</body>

</html>